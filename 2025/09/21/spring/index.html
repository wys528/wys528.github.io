<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>spring | Hexo</title><meta name="author" content="lele"><meta name="copyright" content="lele"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="SpringSpring是企业级一站式框架：  企业级：经过企业实战使用。稳定性高、可靠性强、扩展性好 一站式：一个框架就可以提供企业开发期间的所有解决方案 框架：众多通用功能逻辑的封装集合  广义的Spring： spring.io 提供的所有框架集合。 什么是框架框架（framework）：  建筑学领域：用于承载一个系统必要功能的基础要素的集合 计算机领域：某特定领域系统的一组约定、标准、代">
<meta property="og:type" content="article">
<meta property="og:title" content="spring">
<meta property="og:url" content="http://example.com/2025/09/21/spring/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="SpringSpring是企业级一站式框架：  企业级：经过企业实战使用。稳定性高、可靠性强、扩展性好 一站式：一个框架就可以提供企业开发期间的所有解决方案 框架：众多通用功能逻辑的封装集合  广义的Spring： spring.io 提供的所有框架集合。 什么是框架框架（framework）：  建筑学领域：用于承载一个系统必要功能的基础要素的集合 计算机领域：某特定领域系统的一组约定、标准、代">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2025-09-21T14:57:04.000Z">
<meta property="article:modified_time" content="2025-09-27T14:11:32.747Z">
<meta property="article:author" content="lele">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/image/tx.jpg"><link rel="canonical" href="http://example.com/2025/09/21/spring/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'spring',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-27 22:11:32'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/image/tx.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">140</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Hexo"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/image/test.gif"/><span class="site-name">Hexo</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">spring</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-21T14:57:04.000Z" title="发表于 2025-09-21 22:57:04">2025-09-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-27T14:11:32.747Z" title="更新于 2025-09-27 22:11:32">2025-09-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>62分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="spring"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><p>Spring是企业级一站式框架：</p>
<ul>
<li><strong>企业级</strong>：经过企业实战使用。稳定性高、可靠性强、扩展性好</li>
<li><strong>一站式</strong>：一个框架就可以提供企业开发期间的所有解决方案</li>
<li><strong>框架</strong>：众多通用功能逻辑的封装集合</li>
</ul>
<p><strong>广义的Spring</strong>： spring.io 提供的所有框架集合。</p>
<h2 id="什么是框架"><a href="#什么是框架" class="headerlink" title="什么是框架"></a>什么是框架</h2><p><strong>框架（framework）</strong>：</p>
<ul>
<li><strong>建筑学领域</strong>：用于承载一个<strong>系统必要功能</strong>的<strong>基础要素的集合</strong></li>
<li><strong>计算机领域</strong>：某<strong>特定领域系统</strong>的<strong>一组约定</strong>、<strong>标准</strong>、<strong>代码库</strong>以及<strong>工具</strong>的集合</li>
</ul>
<p>框架与工具的区别：</p>
<p>框架：提供某个领域一系列的解决方案</p>
<p>工具：提供少量的常用小功能封装</p>
<p>可以认为：**<code>框架 = 基础功能 + N多工具</code>**</p>
<ol>
<li><h2 id="Spring-Framework"><a href="#Spring-Framework" class="headerlink" title="Spring Framework"></a>Spring Framework</h2></li>
</ol>
<p>Spring是一个 <strong>IOC(DI)</strong> 和 <strong>AOP 框架</strong></p>
<p><strong>Spring有很多优良特性</strong></p>
<ol>
<li><strong>非侵入式</strong>：基于Spring开发的应用中的对象可以不依赖于Spring的API</li>
<li><strong>依赖注入</strong>：DI（Dependency Injection）是反转控制（IOC）最经典的实现</li>
<li><strong>面向切面编程</strong>：Aspect Oriented Programming - AOP</li>
<li><strong>容器</strong>：Spring是一个容器，包含并管理应用对象的生命周期</li>
<li><strong>组件化</strong>：Spring通过将众多简单的组件配置组合成一个复杂应用。</li>
<li><strong>一站式</strong>：Spring提供了一系列框架，解决了应用开发中的众多问题</li>
</ol>
<h2 id="Spring-模块划分"><a href="#Spring-模块划分" class="headerlink" title="Spring 模块划分"></a>Spring 模块划分</h2><p><strong>Core（核心）</strong>：IoC容器、事件、资源、国际化、数据校验、数据绑定、类型转换、SpEL、AOP、AOT</p>
<p><strong>Testing（测试）</strong>：对象模拟、测试框架、SpringMVC测试、WebTestClient</p>
<p><strong>Data Access（数据访问）</strong>：事务、DAO 支持、JDBC、R2DBC、对象关系映射、XML转换</p>
<p><strong>Web Servlet（Servlet式Web）</strong>：SpringMVC、WebSocket、SockJS、STOMP 消息</p>
<p>Web Reactive（响应式Web）：Spring WebFlux、WebClient、WebSocket、RSocket</p>
<p><strong>Integration（整合）</strong>：REST 客户端、Java消息服务、Java 缓存抽象、Java 管理扩展、邮件、任务、调度、缓存、可观测性、JVM 检查点恢复</p>
<h1 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="组件和容器"><a href="#组件和容器" class="headerlink" title="组件和容器"></a>组件和容器</h3><blockquote>
<p>如何理解组件和容器概念</p>
</blockquote>
<p><strong>组件：****具有一定功能的对象</strong>；比如我们写过的Controller、Service、Dao都是组件，因为他们提供了一系列的方法（也就是具有功能）。一般认为entity不是组件（因为只有数据，没有功能）</p>
<p><strong>容器：****管理组件</strong>（主要对组件进行创建、获取、保存、销毁等）</p>
<h3 id="常见的容器和组件案例"><a href="#常见的容器和组件案例" class="headerlink" title="常见的容器和组件案例"></a>常见的容器和组件案例</h3><h3 id="IOC和DI"><a href="#IOC和DI" class="headerlink" title="IOC和DI"></a>IOC和DI</h3><p><strong>IoC：Inversion of Control（控制反转）</strong></p>
<ul>
<li><strong>控制</strong>：资源（也就是对象）的控制权（资源的创建、获取、销毁等）</li>
<li><strong>反转</strong>：和传统的方式不一样了；<ul>
<li><strong>传统方式</strong>：用啥，程序员自己new啥。</li>
<li><strong>反转方式</strong>：Spring自动发现，缺啥，Spring自己new啥。</li>
<li><strong>不一样之处</strong>：程序员主动new，然后程序用； 变为 程序主动new，然后程序自己用</li>
</ul>
</li>
<li><strong>娶媳妇例子</strong>：<ul>
<li>传统方式：自己谈、自己找</li>
<li>控制反转方式：<strong>老许，你要老婆不要</strong></li>
</ul>
</li>
</ul>
<p><strong>DI ：Dependency Injection（依赖注入）</strong></p>
<ul>
<li><strong>依赖</strong>：组件的依赖关系(不是jar包依赖)，如 NewsController 依赖 NewsServices依赖dao</li>
<li><strong>注入</strong>：通过setter方法、构造器、反射等方式自动的注入,从而不需要自己new对象</li>
</ul>
<p>控制反转是一种思想,实现的方式就是依赖注入。Spring是容器框架用来实现依赖注入;</p>
<p>因此<strong>目前学习的主要目标</strong>就是：<code>想办法把组件注入到spring容器中</code>，先让容器管理起来</p>
<h2 id="组件注册"><a href="#组件注册" class="headerlink" title="组件注册"></a>组件注册</h2><h3 id="实验1：-Bean"><a href="#实验1：-Bean" class="headerlink" title="实验1：@Bean"></a>实验1：@Bean</h3><h4 id="准备一个JavaBean"><a href="#准备一个JavaBean" class="headerlink" title="准备一个JavaBean"></a>准备一个JavaBean</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="注册容器中"><a href="#注册容器中" class="headerlink" title="注册容器中"></a>注册容器中</h4><p>在主程序类中，使用 @Bean 标准在某个方法上，这个方法返回的对象，就会注册到容器中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 主入口类,主程序类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Spring01Application</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//准备一个javabean,给容器中注册一个自己的组件,每个组件都有名字,方法名就是组件的名字 </span></span><br><span class="line">    <span class="comment">//可以通过改方法名或者@bean(&quot;这里写名字&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span>  <span class="comment">//如果组件名重复了,容器里只会有一个组件 按照方法的字母排序或者先                                                          后写的顺序排序</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">p</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(); <span class="comment">//可以下载插件GenerateAllsetter 直接alt回车生成所有的set</span></span><br><span class="line">            person.setName(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">            person.setAge(<span class="number">23</span>);</span><br><span class="line">            person.setGender(<span class="string">&quot;女&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">//注册组件成功后,输出时会有p这个组件</span></span><br></pre></td></tr></table></figure>

<h4 id="从容器中获取"><a href="#从容器中获取" class="headerlink" title="从容器中获取"></a>从容器中获取</h4><p>编写main方法；代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 主入口类,主程序类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Spring01Application</span> &#123;    </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">                <span class="comment">//继承自ApplicationContext:Spring应用上下文</span></span><br><span class="line">                <span class="type">ConfigurableApplicationContext</span> <span class="variable">run</span> <span class="operator">=</span> SpringApplication.run(Spring01Application.class, args);</span><br><span class="line">                <span class="comment">//这个run就是ioc容器</span></span><br><span class="line">                System.out.println(<span class="string">&quot;run = &quot;</span> + run);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//看容器中装了哪些组件</span></span><br><span class="line">                String[] beanDefinitionNames = run.getBeanDefinitionNames();</span><br><span class="line">                <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">                        System.out.println(beanDefinitionName);<span class="comment">//Spring的默认组件</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验2：-获取Bean"><a href="#实验2：-获取Bean" class="headerlink" title="实验2： 获取Bean"></a>实验2： 获取Bean</h3><ol>
<li>组件创建时机：容器启动默认就创建好了。</li>
<li>组件是单实例的。默认只创建一个</li>
<li><strong>从容器中获取组件的</strong>规则：<ol>
<li>1）、组件不存在，抛异常：NoSuchBeanDefinitionException</li>
<li>2）、组件不唯一，<ol>
<li>按照类型只要一个：抛异常：NoUniqueBeanDefinitionException</li>
<li>按照名字只要一个：精确获取到指定对象</li>
<li>按照类型获取多个：返回所有组件的集合（Map）</li>
</ol>
</li>
<li>3）、组件唯一存在，正确返回。</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1、跑起一个Spring的应用；  ApplicationContext：Spring应用上下文对象； IoC容器</span></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">ioc</span> <span class="operator">=</span> SpringApplication.run(Spring01IocApplication.class, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;ioc = &quot;</span> + ioc);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;=============================&quot;</span>);</span><br><span class="line">        <span class="comment">//2、获取到容器中所有组件的名字；容器中装了哪些组件； Spring启动会有很多默认组件</span></span><br><span class="line"><span class="comment">//        String[] names = ioc.getBeanDefinitionNames();</span></span><br><span class="line"><span class="comment">//        for (String name : names) &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;name = &quot; + name);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、获取容器中的组件对象；精确获取某个组件</span></span><br><span class="line">        <span class="comment">// 组件的四大特性：(名字、类型)、对象、作用域</span></span><br><span class="line">        <span class="comment">// 组件名字全局唯一；组件名重复了，一定只会给容器中放一个最先声明的哪个。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//小结：</span></span><br><span class="line">        <span class="comment">//从容器中获取组件，</span></span><br><span class="line">        <span class="comment">//  1）、组件不存在，抛异常：NoSuchBeanDefinitionException</span></span><br><span class="line">        <span class="comment">//  2）、组件不唯一，</span></span><br><span class="line">        <span class="comment">//      按照类型只要一个：抛异常：NoUniqueBeanDefinitionException</span></span><br><span class="line">        <span class="comment">//      按照名字只要一个：精确获取到指定对象</span></span><br><span class="line">        <span class="comment">//      按照类型获取多个：返回所有组件的集合（Map）</span></span><br><span class="line">        <span class="comment">//  3）、组件唯一存在，正确返回。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.1、按照组件的名字获取对象</span></span><br><span class="line">        <span class="type">Person</span> <span class="variable">zhangsan</span> <span class="operator">=</span> (Person) ioc.getBean(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;对象 = &quot;</span> + zhangsan);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.2、按照组件类型获取对象</span></span><br><span class="line"><span class="comment">//        Person bean = ioc.getBean(Person.class);</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;bean = &quot; + bean);</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//4.3、按照组件类型获取这种类型的所有对象</span></span><br><span class="line">        Map&lt;String, Person&gt; type = ioc.getBeansOfType(Person.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;type = &quot;</span> + type);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.4、按照类型+名字</span></span><br><span class="line">        <span class="type">Person</span> <span class="variable">bean</span> <span class="operator">=</span> ioc.getBean(<span class="string">&quot;zhangsan&quot;</span>, Person.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;bean = &quot;</span> + bean);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//5、组件是单实例的....</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验3：-Configuration"><a href="#实验3：-Configuration" class="headerlink" title="实验3：@Configuration"></a>实验3：@Configuration</h3><p><strong>组件</strong>是框架的底层配置</p>
<p>Spring一般用<strong>配置类</strong>来<strong>分类管理组件的配置 ;</strong> 配置类也属于一个组件**@Configuration**</p>
<blockquote>
<p>注意：以后不把那些@bean放在main里, 而是放在一个个配置类里, Person类的组件都放在PersonConfig,xxx类的组件都放在xxxConfig</p>
</blockquote>
<p>包括@Import   @ComponentScan 等都放在配置类下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Person;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.condition.MacCondition;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.condition.WindowsCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//告诉Spring容器，这是一个配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">haha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;张三2&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3、给容器中注册一个自己的组件； 容器中的每个组件都有自己的名字，方法名就是组件的名字</span></span><br><span class="line">    <span class="meta">@Bean(&quot;zhangsan&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">zhangsan</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;张三1&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(&quot;lisi&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">lisi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验4-7：mvc分层注解"><a href="#实验4-7：mvc分层注解" class="headerlink" title="实验4-7：mvc分层注解"></a>实验4-7：mvc分层注解</h3><p><strong>各层标各自的注解</strong>,这个注解是给人看的,都写@Component也行, 底层都是@Component 也包括@Configuration</p>
<p>@Controller： 标在控制器层</p>
<p>@Service：     服务层</p>
<p>@Repository：持久层</p>
<p>@Component：非mvc的其他地方</p>
<blockquote>
<p>注意:分层注解起作用的前提是,这些组件必须在<strong>主程序所在的包及其子包目录结构下</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.dao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：@Controller、@Service、@Repository 底层 都是 @Component；源码如下</p>
<h3 id="实验8：-ComponentScan"><a href="#实验8：-ComponentScan" class="headerlink" title="实验8：@ComponentScan"></a>实验8：@ComponentScan</h3><p>批量扫描：如果某个包下的一堆组件都不在main程序所在的包下，可以使用批量扫描导入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//组件批量扫描； 只扫利用Spring相关注解注册到容器中的组件</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.lfy.spring&quot;)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验9：-Import"><a href="#实验9：-Import" class="headerlink" title="实验9：@Import"></a>实验9：@Import</h3><p>导入第三方组件；因为引入别人的依赖，所以修改不了别人的代码，如果想注册别人包里面的组件，可以使用这个功能； 注意：<code>CoreConstants </code>不是Spring的，是<code>logback</code>的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ch.qos.logback.core.CoreConstants;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Import(&#123;CoreConstants.class&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//组件批量扫描； 只扫利用Spring相关注解注册到容器中的组件</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.lfy.spring&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验10：-Scope"><a href="#实验10：-Scope" class="headerlink" title="实验10：@Scope"></a>实验10：@Scope</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scope</span> 调整组件的作用域：</span></span><br><span class="line"><span class="comment">     * 1、<span class="doctag">@Scope</span>(&quot;prototype&quot;)：非单实例:</span></span><br><span class="line"><span class="comment">     *      容器启动的时候不会创建非单实例组件的对象。</span></span><br><span class="line"><span class="comment">     *      什么时候获取，什么时候创建</span></span><br><span class="line"><span class="comment">     * 2、<span class="doctag">@Scope</span>(&quot;singleton&quot;)：单实例： 默认值</span></span><br><span class="line"><span class="comment">     *      容器启动的时候会创建单实例组件的对象。</span></span><br><span class="line"><span class="comment">     *      容器启动完成之前就会创建好</span></span><br><span class="line"><span class="comment">     *    <span class="doctag">@Lazy</span>：懒加载</span></span><br><span class="line"><span class="comment">     *      容器启动完成之前不会创建懒加载组件的对象</span></span><br><span class="line"><span class="comment">     *      什么时候获取，什么时候创建</span></span><br><span class="line"><span class="comment">     * 3、<span class="doctag">@Scope</span>(&quot;request&quot;)：同一个请求单实例</span></span><br><span class="line"><span class="comment">     * 4、<span class="doctag">@Scope</span>(&quot;session&quot;)：同一次会话单实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test04</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// @Scope(&quot;singleton&quot;)</span></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">ioc</span> <span class="operator">=</span> SpringApplication.run(Spring01IocApplication.class, args);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;=================ioc容器创建完成===================&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">zhangsan1</span> <span class="operator">=</span> ioc.getBean(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;zhangsan1 = &quot;</span> + zhangsan1);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">zhangsan2</span> <span class="operator">=</span> ioc.getBean(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;zhangsan2 = &quot;</span> + zhangsan2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//容器创建的时候（完成之前）就把所有的单实例对象创建完成</span></span><br><span class="line">        System.out.println(zhangsan1 == zhangsan2);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;=========================================&quot;</span>);</span><br><span class="line"><span class="comment">//        Dog bean = ioc.getBean(Dog.class);</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;dog = &quot; + bean);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验11：-Lazy"><a href="#实验11：-Lazy" class="headerlink" title="实验11：@Lazy"></a>实验11：@Lazy</h3><p><strong>懒加载</strong>：需要配合***<code>@Scope(&quot;singleton&quot;)</code>***<em>才能有用；</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2、<span class="doctag">@Scope</span>(&quot;singleton&quot;)：单实例： 默认值</span></span><br><span class="line"><span class="comment">     *      容器启动的时候会创建单实例组件的对象。</span></span><br><span class="line"><span class="comment">     *      容器启动完成之前就会创建好</span></span><br><span class="line"><span class="comment">     *    <span class="doctag">@Lazy</span>：懒加载</span></span><br><span class="line"><span class="comment">     *      容器启动完成之前不会创建懒加载组件的对象</span></span><br><span class="line"><span class="comment">     *      什么时候获取，什么时候创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Person;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.condition.MacCondition;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.condition.WindowsCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//告诉Spring容器，这是一个配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="meta">@Bean(&quot;zhangsan&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">haha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;张三2&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;lisi&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">lisi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验12：FactoryBean"><a href="#实验12：FactoryBean" class="headerlink" title="实验12：FactoryBean"></a>实验12：FactoryBean</h3><p><strong>FactoryBean：工厂Bean</strong>；Spring定义的一个接口，这个组件是一个工厂，他不产生自己类型的对象，而是制造别的对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Car;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.FactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景：如果制造某些对象比较复杂的时候，利用工厂方法进行创建。</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BYDFactory</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Car&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用此方法给容器中制造对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Car <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BYDFactory 正在制造Car对象...&quot;</span>);</span><br><span class="line">        <span class="type">Car</span> <span class="variable">car</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>();</span><br><span class="line">        <span class="keyword">return</span> car;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 说明造的东西的类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Car.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是单例？</span></span><br><span class="line"><span class="comment">     *    true：是单例的；</span></span><br><span class="line"><span class="comment">     *    false：不是单例的；</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// FactoryBean在容器中放的组件的类型，是接口中泛型指定的类型，组件的名字是 工厂自己的名字</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">ioc</span> <span class="operator">=</span> SpringApplication.run(Spring01IocApplication.class, args);</span><br><span class="line">    System.out.println(<span class="string">&quot;=================ioc容器创建完成===================&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">Car</span> <span class="variable">bean1</span> <span class="operator">=</span> ioc.getBean(Car.class);</span><br><span class="line">    <span class="type">Car</span> <span class="variable">bean2</span> <span class="operator">=</span> ioc.getBean(Car.class);</span><br><span class="line">    System.out.println(bean1 == bean2);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Car&gt; beansOfType = ioc.getBeansOfType(Car.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;beansOfType = &quot;</span> + beansOfType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验13：-Conditional【难点】"><a href="#实验13：-Conditional【难点】" class="headerlink" title="实验13：@Conditional【难点】"></a>实验13：@Conditional【难点】</h3><p>条件注册：只有符合某种条件，才会注册对应的Bean</p>
<p>条件注册非常强大，他是SpringBoot的底层原理</p>
<h4 id="原生conditional"><a href="#原生conditional" class="headerlink" title="原生conditional"></a>原生conditional</h4><ol>
<li>创建condition的实现，用来代表匹配某种条件</li>
<li>@Conditional注解指定好条件，标注在某个组件上。这个组件只有符合条件才会注册到容器中</li>
</ol>
<h5 id="条件接口实现"><a href="#条件接口实现" class="headerlink" title="条件接口实现"></a>条件接口实现</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.condition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Condition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConditionContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WindowsCondition</span> <span class="keyword">implements</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;</span><br><span class="line">        <span class="comment">//判断环境变量中的OS 包含windows，就是windows系统</span></span><br><span class="line">        <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> context.getEnvironment();</span><br><span class="line">        <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;OS&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> property.contains(<span class="string">&quot;Windows&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.condition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Condition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConditionContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MacCondition</span> <span class="keyword">implements</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;</span><br><span class="line">        <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> context.getEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;OS&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> property.contains(<span class="string">&quot;mac&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="条件标注在组件上"><a href="#条件标注在组件上" class="headerlink" title="条件标注在组件上"></a>条件标注在组件上</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span> <span class="comment">//告诉Spring容器，这是一个配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//场景：判断当前电脑的操作系统是windows还是mac</span></span><br><span class="line">    <span class="comment">//  windows 系统，容器中有 bill</span></span><br><span class="line">    <span class="comment">//  mac 系统，容器中有 joseph</span></span><br><span class="line">    <span class="meta">@Conditional(MacCondition.class)</span></span><br><span class="line">    <span class="meta">@Bean(&quot;joseph&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">joseph</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;乔布斯&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Conditional(WindowsCondition.class)</span></span><br><span class="line">    <span class="meta">@Bean(&quot;bill&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">bill</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;比尔盖茨&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试条件是否生效"><a href="#测试条件是否生效" class="headerlink" title="测试条件是否生效"></a>测试条件是否生效</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 条件注册</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">ioc</span> <span class="operator">=</span> SpringApplication.run(Spring01IocApplication.class, args);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Person&gt; beans = ioc.getBeansOfType(Person.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;beans = &quot;</span> + beans);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//拿到环境变量</span></span><br><span class="line">    <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> ioc.getEnvironment();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;OS&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;property = &quot;</span> + property);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Dog&gt; beansOfType = ioc.getBeansOfType(Dog.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;dogs = &quot;</span> + beansOfType);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, UserService&gt; ofType = ioc.getBeansOfType(UserService.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;ofType = &quot;</span> + ofType);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Conditional-派生注解"><a href="#Conditional-派生注解" class="headerlink" title="@Conditional 派生注解"></a>@Conditional 派生注解</h4><h2 id="组件注入"><a href="#组件注入" class="headerlink" title="组件注入"></a>组件注入</h2><p>组件注入，就是我们常说的依赖注入；</p>
<h3 id="实验1：-Autowired"><a href="#实验1：-Autowired" class="headerlink" title="实验1：@Autowired"></a>实验1：@Autowired</h3><p>标注：@Autowired，可以让 Spring 把对应的组件自动赋值给这个属性；</p>
<p>注入规则如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动装配流程（先按照类型，再按照名称）</span></span><br><span class="line"><span class="comment">     * 1、按照类型，找到这个组件；</span></span><br><span class="line"><span class="comment">     *      1.0、只有且找到一个，直接注入，名字无所谓</span></span><br><span class="line"><span class="comment">     *      1.1、如果找到多个，再按照名称去找; 变量名就是名字（新版）。</span></span><br><span class="line"><span class="comment">     *           1.1.1、如果找到： 直接注入。</span></span><br><span class="line"><span class="comment">     *           1.1.2、如果找不到，报错</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//自动装配； 原理：Spring 调用 容器.getBean</span></span><br><span class="line">    UserService abc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Person bill;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span>  <span class="comment">//把这个类型的所有组件都拿来</span></span><br><span class="line">    List&lt;Person&gt; personList;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span>  <span class="comment">//key是组件名字，value是组件对象</span></span><br><span class="line">    Map&lt;String,Person&gt; personMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//注入ioc容器自己</span></span><br><span class="line">    ApplicationContext applicationContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验2：-Qualifier"><a href="#实验2：-Qualifier" class="headerlink" title="实验2：@Qualifier"></a>实验2：@Qualifier</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Dog;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Person;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Consider marking one of the beans as <span class="doctag">@Primary</span>,</span></span><br><span class="line"><span class="comment">     * updating the consumer to accept multiple beans,</span></span><br><span class="line"><span class="comment">     * or using <span class="doctag">@Qualifier</span> to identify the bean that should be consumed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Qualifier(&quot;bill&quot;) //精确指定：如果容器中这样的组件存在多个，则使用@Qualifier精确指定组件名</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Qualifier(&quot;bill&quot;)</span> <span class="comment">//精确指定：如果容器中这样的组件存在多个，且有默认组件。我们可以使用 @Qualifier 切换别的组件。</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    Person atom; <span class="comment">// @Primary 一旦存在，改属性名就不能实现组件切换了。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验3：-Primary"><a href="#实验3：-Primary" class="headerlink" title="实验3：@Primary"></a>实验3：@Primary</h3><p>同样类型的组件有多个，如果直接 自动注入 会报错。</p>
<p>这时可以使用 @Primary 标注默认使用哪个组件。自动注入的就是指定的这个组件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ch.qos.logback.core.CoreConstants;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Person;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.condition.MacCondition;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.condition.WindowsCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureOrder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">//告诉Spring容器，这是一个配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span> <span class="comment">//主组件：默认组件</span></span><br><span class="line">    <span class="meta">@Bean(&quot;haha&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">haha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;张三2&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3、给容器中注册一个自己的组件； 容器中的每个组件都有自己的名字，方法名就是组件的名字</span></span><br><span class="line">    <span class="meta">@Bean(&quot;zhangsan&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">zhangsan</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;张三1&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean(&quot;lisi&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">lisi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setName(<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">        person.setAge(<span class="number">20</span>);</span><br><span class="line">        person.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验4：-Resource"><a href="#实验4：-Resource" class="headerlink" title="实验4：@Resource"></a>实验4：@Resource</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Dog;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Person;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//面试题：@Resource 和 @Autowired 区别？</span></span><br><span class="line">    <span class="comment">//1、@Autowired 和 @Resource 都是做bean的注入用的，都可以放在属性上</span></span><br><span class="line">    <span class="comment">//2、@Resource 具有更强的通用性</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    UserDao userDao;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired(required = false)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Resource</span></span><br><span class="line"><span class="comment">//    @Autowired(required = false)</span></span><br><span class="line"><span class="comment">//    Dog dog;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验5：setter方法注入"><a href="#实验5：setter方法注入" class="headerlink" title="实验5：setter方法注入"></a>实验5：setter方法注入</h3><p>setter方法上标注 @Autowired ，Spring会在创建组个组件对象的时候，自动把setter方法中需要的所有参数值，全部自动注入进来。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.dao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Dog;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Dog haha;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDog</span><span class="params">(<span class="meta">@Qualifier(&quot;dog02&quot;)</span> Dog dog)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setDog...&quot;</span>+dog);</span><br><span class="line">        <span class="built_in">this</span>.haha = dog;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验6：构造器注入"><a href="#实验6：构造器注入" class="headerlink" title="实验6：构造器注入"></a>实验6：构造器注入</h3><p>如果一个类只有一个有参构造器，Spring在创建这个类对象的时候，会调用此有参构造器，那么，有参构造器需要的所有对象，Spring都会自动注入（从容器中找，然后赋值）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.dao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.Dog;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Dog haha;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 推荐：构造器注入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dog</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//Spring 自动去容器中找到 构造器需要的所有参数的组件值。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserDao</span><span class="params">(Dog dog)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UserDao...有参构造器：&quot;</span>+dog);</span><br><span class="line">        <span class="built_in">this</span>.haha = dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验7：xxxAware"><a href="#实验7：xxxAware" class="headerlink" title="实验7：xxxAware"></a>实验7：xxxAware</h3><p>xxxAware是Spring提供的感知接口；实现这些接口的组件，Spring会自动把对应的 xxx 注入到组件内。<br>注意：既要实现xxxAware接口，组件还要自己声明变量，保存这些xxxAware传入来的值；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanNameAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.EnvironmentAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HahaService</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentAware</span>, BeanNameAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line">    <span class="keyword">private</span> String myName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOsType</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> environment.getProperty(<span class="string">&quot;OS&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.myName = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">package</span> com.lfy.spring.ioc.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanNameAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.EnvironmentAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HahaService</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentAware</span>, BeanNameAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line">    <span class="keyword">private</span> String myName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOsType</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> environment.getProperty(<span class="string">&quot;OS&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.myName = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验8：-Value"><a href="#实验8：-Value" class="headerlink" title="实验8：@Value"></a>实验8：@Value</h3><p>@Value 可以标注在属性上，给属性指定值；</p>
<p><strong>@Value 三种用法</strong>：</p>
<ol>
<li><em><strong>@Value(“字面值”)</strong></em><em>: 直接赋值；</em></li>
<li>***@Value(“${key}”)***<em>：动态从配置文件中取出某一项的值。</em></li>
<li>***@Value(“#{SpEL}”)***<em>：Spring Expression Language；Spring 表达式语言</em><ol>
<li><em>更多写法：**<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/core/expressions.html">https://docs.spring.io/spring-framework/reference/core/expressions.html</a></em></li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.bean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired // 自动注入组件的。基本类型，自己搞。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、<span class="doctag">@Value</span>(&quot;字面值&quot;): 直接赋值</span></span><br><span class="line"><span class="comment">     * 2、<span class="doctag">@Value</span>(&quot;$&#123;key&#125;&quot;)：动态从配置文件中取出某一项的值。</span></span><br><span class="line"><span class="comment">     * 3、<span class="doctag">@Value</span>(&quot;#&#123;SpEL&#125;&quot;)：Spring Expression Language；Spring 表达式语言</span></span><br><span class="line"><span class="comment">     *      更多写法：https://docs.spring.io/spring-framework/reference/core/expressions.html</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;旺财&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;dog.age&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SpEL： 字面量与计算</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;10*20&#125;&quot;)</span> </span><br><span class="line">    <span class="keyword">private</span> String color;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//SpEL： #&#123;T(类名).方法()&#125;；静态方法调用</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;T(java.util.UUID).randomUUID().toString()&#125;&quot;)</span> </span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SpEL： #&#123;对象.方法()&#125;；实例方法调用</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;Hello World!&#x27;.substring(0, 5)&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SpEL： #&#123;new 对象().方法()&#125;； 支持创建对象</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;new String(&#x27;haha&#x27;).toUpperCase()&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String flag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SpEL： #&#123;new int[] &#123;1, 2, 3&#125;&#125;； 数组</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;new int[] &#123;1, 2, 3&#125;&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] hahaha;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Dog构造器...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验9：SpEL"><a href="#实验9：SpEL" class="headerlink" title="实验9：SpEL"></a>实验9：SpEL</h3><p>*SpEL：Spring Expression Language；Spring 表达式语言</p>
<p> <em><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/core/expressions.html">https://docs.spring.io/spring-framework/reference/core/expressions.html</a></em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//SpEL： 字面量与计算</span></span><br><span class="line"><span class="meta">@Value(&quot;#&#123;10*20&#125;&quot;)</span> </span><br><span class="line"><span class="keyword">private</span> String color;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpEL： #&#123;T(类名).方法()&#125;；静态方法调用</span></span><br><span class="line"><span class="meta">@Value(&quot;#&#123;T(java.util.UUID).randomUUID().toString()&#125;&quot;)</span> </span><br><span class="line"><span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpEL： #&#123;对象.方法()&#125;；实例方法调用</span></span><br><span class="line"><span class="meta">@Value(&quot;#&#123;&#x27;Hello World!&#x27;.substring(0, 5)&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpEL： #&#123;new 对象().方法()&#125;； 支持创建对象</span></span><br><span class="line"><span class="meta">@Value(&quot;#&#123;new String(&#x27;haha&#x27;).toUpperCase()&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String flag;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpEL： #&#123;new int[] &#123;1, 2, 3&#125;&#125;； 数组</span></span><br><span class="line"><span class="meta">@Value(&quot;#&#123;new int[] &#123;1, 2, 3&#125;&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span>[] hahaha;</span><br></pre></td></tr></table></figure>

<h3 id="实验10：-PropertySource"><a href="#实验10：-PropertySource" class="headerlink" title="实验10：@PropertySource"></a>实验10：@PropertySource</h3><p>@PropertySource 用来导入 .properties 文件。这样就可以在任意位置使用 @Value 取出配置文件中的值;</p>
<p>用法：<code>@PropertySource(&quot;classpath:conf/cat.properties&quot;)</code></p>
<p>支持的写法：</p>
<ol>
<li><code>classpath:cat.properties</code>；从自己的项目类路径下找</li>
<li><code>classpath*:Log4j-charsets.properties</code>；从所有包的类路径下找</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.bean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.PropertySource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//说明属性来源： 把指定的文件导入容器中，供我们取值使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1、classpath:cat.properties；从自己的项目类路径下找</span></span><br><span class="line"><span class="comment">// 2、classpath*:Log4j-charsets.properties；从所有包的类路径下找</span></span><br><span class="line"><span class="meta">@PropertySource(&quot;classpath:conf/cat.properties&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cat</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;cat.name:Tom&#125;&quot;)</span> <span class="comment">// : 后面是取不到的时候的默认值；</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;cat.age:20&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>扩展：ResourceUtil：Spring提供的可以从类路径下获取资源的工具类；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">ioc</span> <span class="operator">=</span> SpringApplication.run(Spring01IocApplication.class, args);</span><br><span class="line">    System.out.println(<span class="string">&quot;=================ioc容器创建完成===================&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Dog</span> <span class="variable">bean</span> <span class="operator">=</span> ioc.getBean(Dog.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;bean = &quot;</span> + bean);</span><br><span class="line"></span><br><span class="line">    <span class="type">Cat</span> <span class="variable">bean1</span> <span class="operator">=</span> ioc.getBean(Cat.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;cat = &quot;</span> + bean1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> ResourceUtils.getFile(<span class="string">&quot;classpath:abc.jpg&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;file = &quot;</span> + file);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file).available();</span><br><span class="line">    System.out.println(<span class="string">&quot;available = &quot;</span> + available);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验11：-Profile"><a href="#实验11：-Profile" class="headerlink" title="实验11：@Profile"></a>实验11：@Profile</h3><blockquote>
<p>@Profile 是 @Conditional 的一种变体；用来支持多环境</p>
</blockquote>
<p>实验场景：</p>
<ol>
<li>准备 MyDataSource 组件，用来封装数据源</li>
<li>开发、测试、生产环境要有自己对应的数据源，他们的url、账号密码等都不一样</li>
<li>可以激活某个环境，这个环境的数据源就会自动生效</li>
</ol>
<p>MyDataSource 组件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDataSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Profile 指定环境标识</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.datasource.MyDataSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Profile;</span><br><span class="line"><span class="comment">//@Profile(&quot;dev&quot;) //整体激活</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、定义环境标识：自定义【dev、test、prod】； 默认【default】</span></span><br><span class="line">    <span class="comment">//2、激活环境标识：</span></span><br><span class="line">    <span class="comment">//      明确告诉Spring当前处于什么环境。</span></span><br><span class="line">    <span class="comment">//      你要不说是啥环境，就是 default 环境</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//利用条件注解，只在某种环境下激活一个组件。</span></span><br><span class="line">    <span class="meta">@Profile(&#123;&quot;dev&quot;,&quot;default&quot;&#125;)</span>  <span class="comment">//  @Profile(&quot;环境标识&quot;)。当这个环境被激活的时候，才会加入如下组件。</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyDataSource <span class="title function_">dev</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MyDataSource</span> <span class="variable">myDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyDataSource</span>();</span><br><span class="line">        myDataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/dev&quot;</span>);</span><br><span class="line">        myDataSource.setUsername(<span class="string">&quot;dev_user&quot;</span>);</span><br><span class="line">        myDataSource.setPassword(<span class="string">&quot;dev_pwd&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> myDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Profile(&quot;test&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyDataSource <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MyDataSource</span> <span class="variable">myDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyDataSource</span>();</span><br><span class="line">        myDataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>);</span><br><span class="line">        myDataSource.setUsername(<span class="string">&quot;test_user&quot;</span>);</span><br><span class="line">        myDataSource.setPassword(<span class="string">&quot;test_pwd&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> myDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Profile(&quot;prod&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyDataSource <span class="title function_">prod</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MyDataSource</span> <span class="variable">myDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyDataSource</span>();</span><br><span class="line">        myDataSource.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/prod&quot;</span>);</span><br><span class="line">        myDataSource.setUsername(<span class="string">&quot;prod_user&quot;</span>);</span><br><span class="line">        myDataSource.setPassword(<span class="string">&quot;prod_pwd&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> myDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>激活环境： </p>
<ol>
<li>修改 <code>application.properties</code>；</li>
<li>指定配置：<code>spring.profiles.active=dev</code></li>
</ol>
</blockquote>
<h2 id="组件生命周期（了解）"><a href="#组件生命周期（了解）" class="headerlink" title="组件生命周期（了解）"></a>组件生命周期（了解）</h2><p>Spring容器中的组件<strong>从创建</strong>到<strong>运行</strong>到<strong>销毁</strong>，每个时机，Spring都提供了感知扩展回调方法。只需要按照Spring的规则编码，这样，这个组件生命周期到哪个阶段后，<strong>Spring就会调用你的这个方法（回调机制）</strong></p>
<h3 id="实验1：-Bean-1"><a href="#实验1：-Bean-1" class="headerlink" title="实验1：@Bean"></a>实验1：@Bean</h3><p>@Bean：可以设置两种生命周期回调</p>
<ul>
<li><strong>initMethod</strong>：初始化方法；构造器创建好对象后，要对<strong>对象进行初始化</strong>（也就是各种属性默认赋值）</li>
<li><strong>destroyMethod</strong>：销毁方法；容器删除组件时调用的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(initMethod = &quot;initUser&quot;,destroyMethod = &quot;destoryUser&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; User 构造器...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initUser</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; @Bean 初始化：initUser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destoryUser</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; @Bean 销毁：destoryUser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验2-3：InitializingBean、DisposableBean"><a href="#实验2-3：InitializingBean、DisposableBean" class="headerlink" title="实验2-3：InitializingBean、DisposableBean"></a>实验2-3：InitializingBean、DisposableBean</h3><p><code>InitializingBean </code>接口，包含<code>afterPropertiesSet</code>方法（顾名思义：属性设置后）；</p>
<p><code>DisposableBean </code>接口，包含 <code>destroy </code>方法（顾名思义：销毁）</p>
<p>以上两个接口提供的生命周期回调方法，会在对应的时机，由Spring框架触发调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.bean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PreDestroy;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.DisposableBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//BeanPostProcessor：Bean外挂修改器</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>, DisposableBean &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCar</span><span class="params">(Car car)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; setter 自动注入：属性值：&quot;</span>+car);</span><br><span class="line">        <span class="built_in">this</span>.car = car;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; User 构造器...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initUser</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; @Bean 初始化：initUser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destoryUser</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; @Bean 销毁：destoryUser&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 属性设置之后进行调用： set赋值完成了</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; 【InitializingBean】 ==== afterPropertiesSet....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; 【DisposableBean】 ==== destroy....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验4-5：-PostConstruct、-PreDestroy"><a href="#实验4-5：-PostConstruct、-PreDestroy" class="headerlink" title="实验4-5：@PostConstruct、@PreDestroy"></a>实验4-5：@PostConstruct、@PreDestroy</h3><p>@PostConstruct 注解（顾名思义：构造器后置方法），标注在某个方法上，构造器调用后，此方法会被回调</p>
<p>@PreDestroy 注解（顾名思义：销毁前），标注在某个方法上，组件销毁之前，此方法会被回调</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.bean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>, DisposableBean &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; User 构造器...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span> <span class="comment">//构造器之后</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postConstruct</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; @PostConstruct....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preDestroy</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【User】 ==&gt; @PreDestroy....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验6：BeanPostProcessor"><a href="#实验6：BeanPostProcessor" class="headerlink" title="实验6：BeanPostProcessor"></a>实验6：BeanPostProcessor</h3><p>BeanPostProcessor：Bean后置处理器； 会拦截所有Bean的创建过程，提供两个方法</p>
<ol>
<li>postProcessAfterInitialization：  初始化后的回调函数</li>
<li>postProcessBeforeInitialization： 初始化前的回调函数</li>
</ol>
<p><strong>初始化前</strong>：一般认为Bean的属性赋值还没有完成</p>
<p><strong>初始化后</strong>：一般认为Bean的属性值就已经创建完成</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc.processor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//拦截所有Bean的后置处理器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTestBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【postProcessAfterInitialization】：&quot;</span>+beanName);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【postProcessBeforeInitialization】：&quot;</span>+beanName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(bean <span class="keyword">instanceof</span> User hello)&#123;</span><br><span class="line">            hello.setUsername(<span class="string">&quot;张三测试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ol>
<li><strong>组件 放到 容器中</strong>，以后才能有用<ol>
<li>使用之前实验的 组件注册 的各种方法，把组件放到容器中</li>
</ol>
</li>
<li>容器（Spring）能为他里面的所有组件提供各种强大功能，比如<ol>
<li><strong>自动依赖注入：记住几个常用的</strong><ol>
<li><strong>@Value：配置文件取值</strong></li>
<li><strong>@Autowired</strong>：<strong>自动注入</strong></li>
<li><strong>构造器注入</strong></li>
<li><strong>@Profile</strong>：多环境适配</li>
</ol>
</li>
<li><strong>声明式事务</strong>（后来讲）</li>
<li><strong>AOP：面向切面编程</strong>（后来讲）</li>
</ol>
</li>
<li>单元测试：<ol>
<li>以后单元测试类标注 <strong><code>@SpringBootTest</code></strong></li>
<li>这个测试类就可以放心大胆的**<code>@Autowired</code>**容器中的组件进行测试</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.ioc;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.bean.User;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.ioc.dao.DeliveryDao;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SpringBoot 单元测试，可以直接测试Spring容器中的组件</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    User user;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DeliveryDao deliveryDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        System.out.println(<span class="string">&quot;string = &quot;</span> + string);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="comment">//        System.out.println(&quot;user = &quot; + user);</span></span><br><span class="line">        deliveryDao.saveDelivery();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><p><strong>AOP：Aspect Oriented Programming（面向切面编程）</strong></p>
<p><strong>OOP：Object Oriented Programming（面向对象编程）</strong></p>
<p>面向切面编程：一种可以在<strong>程序运行过程中</strong>，<strong>动态加入</strong>部分<strong>代码逻辑</strong>的技术</p>
<p><strong>场景设计</strong></p>
<ol>
<li>设计：编写一个计算器接口和实现类，提供加减乘除四则运算</li>
<li>需求：在加减乘除运算的时候需要记录操作日志（运算前参数、运算后结果）</li>
<li><strong>实现：</strong><ol>
<li>静态代理</li>
<li>动态代理</li>
<li>AOP</li>
</ol>
</li>
</ol>
<h2 id="场景搭建"><a href="#场景搭建" class="headerlink" title="场景搭建"></a>场景搭建</h2><h3 id="MathCalculator-接口"><a href="#MathCalculator-接口" class="headerlink" title="MathCalculator 接口"></a>MathCalculator 接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop.calculator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MathCalculator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义 四则运算</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> i,<span class="type">int</span> j)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//减法</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> i,<span class="type">int</span> j)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//乘法</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">mul</span><span class="params">(<span class="type">int</span> i,<span class="type">int</span> j)</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//除法</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">div</span><span class="params">(<span class="type">int</span> i,<span class="type">int</span> j)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MathCalculatorImpl-实现类"><a href="#MathCalculatorImpl-实现类" class="headerlink" title="MathCalculatorImpl 实现类"></a>MathCalculatorImpl 实现类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop.calculator.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.aop.calculator.MathCalculator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MathCalculatorImpl</span> <span class="keyword">implements</span> <span class="title class_">MathCalculator</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> i + j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> i - j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">mul</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> i * j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">div</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> i / j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="给计算方法加日志"><a href="#给计算方法加日志" class="headerlink" title="给计算方法加日志"></a>给计算方法加日志</h3><p> <em>添加日志的两种方式：</em> <em>1、</em><em><strong>硬编码</strong></em><em>： 不推荐； 耦合：（通用逻辑 + 专用逻辑）希望不要耦合； 耦合太多就是维护地狱</em> <em>2、</em><em><strong>静态代理</strong></em><em>：</em>       <em>定义：定义一个代理对象，包装这个组件。以后业务的执行，从代理开始，不直接调用组件；</em>      <em>特点：定义期间就指定好了互相代理关系</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop.calculator.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.aop.calculator.MathCalculator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MathCalculatorImpl</span> <span class="keyword">implements</span> <span class="title class_">MathCalculator</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line"><span class="comment">//        System.out.println(&quot;【日志】add 开始：参数：&quot;+i+&quot;,&quot;+j);</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> i + j;</span><br><span class="line">        System.out.println(<span class="string">&quot;结果：&quot;</span>+result);</span><br><span class="line"><span class="comment">//        System.out.println(&quot;【日志】add 返回：结果：&quot;+result);</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> i - j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">mul</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> i * j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">div</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> i / j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加日志业务实现"><a href="#添加日志业务实现" class="headerlink" title="添加日志业务实现"></a>添加日志业务实现</h2><h3 id="静态代理实现添加日志"><a href="#静态代理实现添加日志" class="headerlink" title="静态代理实现添加日志"></a>静态代理实现添加日志</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop.proxy.statics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.aop.calculator.MathCalculator;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 静态代理：   编码时期间就决定好了代理的关系</span></span><br><span class="line"><span class="comment"> *    定义：代理对象，是目标对象的接口的子类型，代理对象本身并不是目标对象，而是将目标对象作为自己的属性。</span></span><br><span class="line"><span class="comment"> *    优点：同一种类型的所有对象都能代理</span></span><br><span class="line"><span class="comment"> *    缺点：范围太小了，只能负责部分接口代理功能</span></span><br><span class="line"><span class="comment"> * 动态代理：   运行期间才决定好了代理关系（拦截器：拦截所有）</span></span><br><span class="line"><span class="comment"> *    定义：目标对象在执行期间会被动态拦截，插入指定逻辑</span></span><br><span class="line"><span class="comment"> *    优点：可以代理世间万物</span></span><br><span class="line"><span class="comment"> *    缺点：不好写</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalculatorStaticProxy</span> <span class="keyword">implements</span> <span class="title class_">MathCalculator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MathCalculator target; <span class="comment">//目标对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CalculatorStaticProxy</span><span class="params">(MathCalculator mc)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.target = mc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【日志】add 开始：参数：&quot;</span>+i+<span class="string">&quot;,&quot;</span>+j);</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> target.add(i, j);</span><br><span class="line">        System.out.println(<span class="string">&quot;【日志】add 返回：结果：&quot;</span>+result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> target.sub(i,j);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">mul</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> target.mul(i,j);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">div</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> target.div(i,j);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态代理实现添加日志"><a href="#动态代理实现添加日志" class="headerlink" title="动态代理实现添加日志"></a>动态代理实现添加日志</h3><p><strong>动态代理：</strong>是Java 反射包提供的功能。使用 <code>Proxy.</code>*<code>newProxyInstance() </code>*<em>方法，可以获取一个对象的代理对象。</em></p>
<p><strong>代理对象就是对原生对象的一种封装</strong>，每次要执行原生对象方法的时候，代理对象就会拦截方法的执行。将方法的执行权交给代理对象。只有<strong>代理对象调用</strong> <code>method.invoke(target, args)</code>; 原生对象的方法才能被真正执行。</p>
<p><em><strong>由于JDK提供的动态代理功能，必须要求写接口，写实现，才能创建动态代理，有点麻烦。所以我们后来会直接使用Spring AOP功能来替代动态代理</strong></em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop.proxy.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.aop.log.LogUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态代理： JDK动态代理；</span></span><br><span class="line"><span class="comment"> * 强制要求，目标对象必有接口。代理的也只是接口规定的方法。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicProxy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取目标对象的代理对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getProxyInstance</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(),</span><br><span class="line">                target.getClass().getInterfaces(),</span><br><span class="line">                (proxy, method, args) -&gt; &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> method.getName();</span><br><span class="line">                    <span class="comment">//记录开始</span></span><br><span class="line">                    LogUtils.logStart(name, args);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        result = method.invoke(target, args);</span><br><span class="line">                        <span class="comment">//记录返回值</span></span><br><span class="line">                        LogUtils.logReturn(name, result);</span><br><span class="line">                    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                        <span class="comment">//记录异常</span></span><br><span class="line">                        LogUtils.logException(name, e);</span><br><span class="line">                    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="comment">//记录结束</span></span><br><span class="line">                        LogUtils.logEnd(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AOP-实现"><a href="#AOP-实现" class="headerlink" title="AOP 实现"></a>AOP 实现</h2><p>Spring AOP 可以在目标方法 <strong>执行之前、执行返回结果时、执行结束后、执行出异常时</strong> 提供快速的拦截操作。到了指定时机，Spring就会回调对应的方法；</p>
<h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><p><strong>目标对象****（target）</strong>：就是原生的 <code>new MathCalculatorImpl() </code>对象；</p>
<p><strong>代理对象****（proxy）</strong>：Spring会自动的为目标对象（也就是原生对象）</p>
<p><strong>横切关注点****：方法的几个执行时机</strong></p>
<ol>
<li><strong>方法开始</strong>：方法执行之前</li>
<li><strong>方法返回</strong>：方法执行完成，没有异常得到了返回值后</li>
<li><strong>方法异常</strong>：方法出现异常，导致中断，来到了catch逻辑</li>
<li><strong>方法结束</strong>：方法无论执行成功或者失败，总是要结束，也就是 finally 里面逻辑</li>
</ol>
<p><strong>通知方法</strong>：在每个方法的执行时机，我们可能需要Spring回调一个方法。比如：加法执行前，需要调用记录日志方法。这个记录日志方法就称为通知方法；有五种通知</p>
<ol>
<li><strong>前置通知</strong>：在目标方法调用之前调用</li>
<li><strong>返回通知</strong>：在目标方法执行得到返回值后调用</li>
<li><strong>异常通知</strong>：在目标方法执行出现异常后调用</li>
<li><strong>后置通知</strong>：在目标方法结束之后（无论正常还是异常）调用</li>
<li><strong>环绕通知</strong>：完全自定义在目标方法执行的哪个位置调用。且可以拦截影响目标方法的执行</li>
</ol>
<p><strong>切面类</strong>：按照面向对象的封装原则，我们会把所有日志方法都封装到日志类中。这个日志类我们就叫切面类</p>
<p><strong>连接点</strong>：每个横切关注点的位置，都是一个<strong>连接点</strong>，这个连接点未来会封装当前正在执行的方法的详细信息。</p>
<p><strong>切入点</strong>：连接点有很多，但是我们真正感兴趣需要切入的，我们称为切入点。</p>
<p><strong>切入点表达式</strong>：需要使用Spring规定的切入点表达式写法，从众多连接点中，找到我们需要切入的点。</p>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><p><strong>步骤：</strong></p>
<p>1、导入 AOP 依赖</p>
<p>2、编写切面 Aspect</p>
<p>3、编写通知方法</p>
<p>4、指定切入点表达式</p>
<p>5、测试 AOP 动态织入</p>
<h4 id="导入aop依赖"><a href="#导入aop依赖" class="headerlink" title="导入aop依赖"></a>导入aop依赖</h4><p>pom.xml 文件中添加如下依赖；</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="编写切面"><a href="#编写切面" class="headerlink" title="编写切面"></a>编写切面</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//告诉Spring这个组件是个切面。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="编写通知方法"><a href="#编写通知方法" class="headerlink" title="编写通知方法"></a>编写通知方法</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop.aspect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//告诉Spring这个组件是个切面。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、告诉Spring，以下通知何时何地运行？</span></span><br><span class="line"><span class="comment"> *      何时？</span></span><br><span class="line"><span class="comment"> *         <span class="doctag">@Before</span>：方法执行之前运行。</span></span><br><span class="line"><span class="comment"> *         <span class="doctag">@AfterReturning</span>：方法执行正常返回结果运行。</span></span><br><span class="line"><span class="comment"> *         <span class="doctag">@AfterThrowing</span>：方法抛出异常运行。</span></span><br><span class="line"><span class="comment"> *         <span class="doctag">@After</span>：方法执行之后运行</span></span><br><span class="line"><span class="comment"> *         <span class="doctag">@Around</span>：环绕通知；可以控制目标方法是否执行，修改目标方法参数、执行结果等。</span></span><br><span class="line"><span class="comment"> */</span>   </span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logStart</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logEnd</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logReturn</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logException</span><span class="params">()</span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="切入点表达式"><a href="#切入点表达式" class="headerlink" title="切入点表达式"></a>切入点表达式</h4><blockquote>
<p>切入点表达式是来告诉Spring，通知方法应该在哪个时机执行</p>
</blockquote>
<blockquote>
<p><em>切入点表达式；</em>*<code>execution(方法的全签名)</code>*<em>；方法全签名可以支持通配符写法；如下</em></p>
<ol>
<li><em><strong>全写法</strong></em><em>：</em></li>
</ol>
<p><em><code>[public] int [com.lfy.spring.aop.calculator.MathCalculator].add(int,int) [throws ArithmeticException]</code></em></p>
<ol>
<li><em><strong>省略写法</strong></em>：*<code>int add(int i,int j)</code>*</li>
<li><em><strong>通配符</strong></em><em>：</em><ol>
<li>***<code>\*</code>*<em><strong>：</strong>表示任意字符</em></li>
<li>***<code>..</code>***<em>：表示任意多个匹配</em><ol>
<li><em><strong>写在参数位置</strong></em><em>：表示多个参数，任意类型</em></li>
<li><em><strong>写在全类名位置</strong></em>：<em>代表多个层级</em></li>
</ol>
</li>
</ol>
</li>
<li><strong>完全模糊匹配写法</strong>：*<code>\* *(..)</code>*</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop.aspect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Order(10000)</span> <span class="comment">//数字越小，优先级越高，数字越大，优先级越低; 数字越小，越先执行，就必须套到最外层</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//告诉Spring这个组件是个切面。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(int com.lfy.spring.aop.calculator.MathCalculator.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointCut</span><span class="params">()</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、告诉Spring，以下通知何时何地运行？</span></span><br><span class="line"><span class="comment">     *      何时？</span></span><br><span class="line"><span class="comment">     *         <span class="doctag">@Before</span>：方法执行之前运行。</span></span><br><span class="line"><span class="comment">     *         <span class="doctag">@AfterReturning</span>：方法执行正常返回结果运行。</span></span><br><span class="line"><span class="comment">     *         <span class="doctag">@AfterThrowing</span>：方法抛出异常运行。</span></span><br><span class="line"><span class="comment">     *         <span class="doctag">@After</span>：方法执行之后运行</span></span><br><span class="line"><span class="comment">     *         <span class="doctag">@Around</span>：环绕通知；可以控制目标方法是否执行，修改目标方法参数、执行结果等。</span></span><br><span class="line"><span class="comment">     *      何地？</span></span><br><span class="line"><span class="comment">     *         切入点表达式：</span></span><br><span class="line"><span class="comment">     *           execution(方法的全签名)：</span></span><br><span class="line"><span class="comment">     *             全写法：[public] int [com.lfy.spring.aop.calculator.MathCalculator].add(int,int) [throws ArithmeticException]</span></span><br><span class="line"><span class="comment">     *             省略写法：int add(int i,int j)</span></span><br><span class="line"><span class="comment">     *             通配符：</span></span><br><span class="line"><span class="comment">     *               *：表示任意字符</span></span><br><span class="line"><span class="comment">     *               ..：</span></span><br><span class="line"><span class="comment">     *                   1）、参数位置：表示多个参数，任意类型</span></span><br><span class="line"><span class="comment">     *                   2）、类型位置：代表多个层级</span></span><br><span class="line"><span class="comment">     *             最省略: * *(..)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 2、通知方法的执行顺序：</span></span><br><span class="line"><span class="comment">     *      1、正常链路：  前置通知-&gt;目标方法-&gt;返回通知-&gt;后置通知</span></span><br><span class="line"><span class="comment">     *      2、异常链路：  前置通知-&gt;目标方法-&gt;异常通知-&gt;后置通知</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 3、JoinPoint： 包装了当前目标方法的所有信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(&quot;pointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logStart</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        <span class="comment">//1、拿到方法全签名</span></span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//方法名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line">        <span class="comment">//目标方法传来的参数值</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】【&quot;</span>+name+<span class="string">&quot;】开始：参数列表：【&quot;</span>+ Arrays.toString(args) +<span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;pointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logEnd</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】【&quot;</span>+name+<span class="string">&quot;】后置...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(value = &quot;pointCut()&quot;,</span></span><br><span class="line"><span class="meta">                    returning = &quot;result&quot;)</span> <span class="comment">//returning=&quot;result&quot; 获取目标方法返回值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logReturn</span><span class="params">(JoinPoint joinPoint,Object result)</span>&#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】【&quot;</span>+name+<span class="string">&quot;】返回：值：&quot;</span>+result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(</span></span><br><span class="line"><span class="meta">            value = &quot;pointCut()&quot;,</span></span><br><span class="line"><span class="meta">            throwing = &quot;e&quot; //throwing=&quot;e&quot; 获取目标方法抛出的异常</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logException</span><span class="params">(JoinPoint joinPoint,Throwable e)</span>&#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】【&quot;</span>+name+<span class="string">&quot;】异常：错误信息：【&quot;</span>+e.getMessage()+<span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//参数带什么就切</span></span><br><span class="line"><span class="comment">//    @Before(&quot;args(int,int)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">haha</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】哈哈哈...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//参数上有没有标注注解</span></span><br><span class="line"><span class="comment">//    @Before(&quot;@args(com.lfy.spring.aop.annotation.MyAn) &amp;&amp; within(com.lfy.spring.aop.service.UserService)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hehehe</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】呵呵呵...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方法上</span></span><br><span class="line"><span class="comment">//    @Before(&quot;@annotation(com.lfy.spring.aop.annotation.MyAn)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】MyAn测试...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AOP功能测试"><a href="#AOP功能测试" class="headerlink" title="AOP功能测试"></a>AOP功能测试</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.aop.annotation.MyAn;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.aop.calculator.MathCalculator;</span><br><span class="line"><span class="keyword">import</span> com.lfy.spring.aop.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AopTest</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//容器中是它的代理对象</span></span><br><span class="line">    MathCalculator mathCalculator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test02</span><span class="params">()</span> &#123;</span><br><span class="line">        mathCalculator.div(<span class="number">10</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//        System.out.println(mathCalculator.getClass()); //实现类</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        mathCalculator.add(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">//        System.out.println(&quot;============&quot;);</span></span><br><span class="line"><span class="comment">//        mathCalculator.div(10, 2);</span></span><br><span class="line"></span><br><span class="line">        userService.getUserHaha(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;============&quot;</span>);</span><br><span class="line">        userService.updateUser();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AOP原理"><a href="#AOP原理" class="headerlink" title="AOP原理"></a>AOP原理</h4><p><code>mathCalculator.add(10, 20);</code> 如何执行，并动态切入了通知方法 <strong>1. 增强器链：</strong> 切面中的所有通知方法其实就是增强器。他们被组织成一个链路放到集合中。目标方法真正执行前后，会去增强器链中执行哪些需要提前执行的方法。 <strong>2. AOP 的底层原理</strong> 1、Spring会为每个被切面切入的组件创建代理对象(Spring CGLIB 创建的代理对象，无视接口)。 2、代理对象中保存了切面类里面所有通知方法构成的增强器链。 3、目标方法执行时，会先去增强器链中拿到需要提前执行的通知方法，然后执行这个通知方法</p>
<h2 id="AOP-细节"><a href="#AOP-细节" class="headerlink" title="AOP 细节"></a>AOP 细节</h2><h3 id="通知方法执行顺序"><a href="#通知方法执行顺序" class="headerlink" title="通知方法执行顺序"></a>通知方法执行顺序</h3><p>通知方法的执行顺序</p>
<p><strong>正常：</strong>前置通知 &#x3D;&#x3D;》目标方法 &#x3D;&#x3D;》返回通知 &#x3D;&#x3D;》后置通知</p>
<p><strong>异常：</strong>前置通知 &#x3D;&#x3D;》目标方法 &#x3D;&#x3D;》异常通知 &#x3D;&#x3D;》后置通知</p>
<h3 id="切入点表达式-1"><a href="#切入点表达式-1" class="headerlink" title="切入点表达式"></a>切入点表达式</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html">https://docs.spring.io/spring-framework/reference/core/aop/ataspectj/pointcuts.html</a></p>
</blockquote>
<p>在 Spring AOP 中，切入点表达式（pointcut expressions）可以利用多种切点（pointcut）设计ator 来匹配连接点（Join point）。常见的切面表达式及其写法包括以下几种（可以通过逻辑运算符 &amp;&amp;、||、! 进行组合）：</p>
<ol>
<li><strong>execution(…)</strong> • 用于匹配方法执行的连接点，是最常用的切点类型。 • 基本格式为： <strong><code>execution([修饰符模式] 返回值模式 [类全限定名模式].方法名模式(参数模式) [throws 异常模式])</code></strong> • 其中各部分都可以使用通配符(<em>)，如：</em><em><code>execution(</code></em><code> com.example.service.</code><em><code>.</code></em><code>(..))</code> 表示匹配 com.example.service 包下所有类的所有方法，方法的返回值不限制，参数不限制。</li>
<li><strong>within(…)</strong> • 用于匹配某个类型或者某些类型（类或接口）内部的所有方法。 • 基本格式为：<code>within(类型模式)</code> • 例如：<code>within(com.example.service.*)</code> 表示匹配 com.example.service 包下所有类中的所有方法。</li>
<li><strong>this(…)</strong> • 用于匹配当前 AOP 代理对象（proxied object）的类型是否为指定类型（或其子类型）。 • 基本格式为：<code>this(类型表达式)</code> • 例如：<code>this(com.example.service.MyService)</code> 表示在运行时检查代理对象是否是 MyService 类型（或其子类型）。</li>
<li><strong>target(…)</strong> • 用于匹配目标对象（目标类，而非代理类）的类型是否为指定类型（或其子类型）。 • 基本格式为：**<code>target(类型表达式)</code>** • 例如：<code>target(com.example.service.MyService)</code></li>
<li><strong>args(…)</strong> • 用于匹配连接点（方法）参数的类型是否与指定类型相匹配（或其子类型）。 • 基本格式为：<code>args(类型表达式列表)</code> • 例如：**<code>args(String, \*)</code>** 表示匹配第一个参数为 String 类型，第二个参数任意类型的方法。</li>
<li><strong>@target(…)</strong> • 用于匹配目标对象的类型上是否存在某个注解（annotation）。 • 基本格式为：<code>@target(注解类型)</code> • 例如：<code>@target(org.springframework.stereotype.Service)</code></li>
<li><strong>@within(…)</strong> • 用于匹配当前执行方法的类是否被某个注解标注（在类级别上）。 • 基本格式为：<code>@within(注解类型)</code> • 例如：@within(org.springframework.stereotype.Component)</li>
<li><strong>@annotation(…)</strong> • 用于匹配当前执行的方法是否使用了某个注解。 • 基本格式为：<code>@annotation(注解类型)</code> • 例如：<code>@annotation(org.springframework.transaction.annotation.Transactional)</code></li>
<li><strong>@args(…)</strong> • 用于匹配执行方法的参数（运行时）所带有的注解类型。 • 基本格式为：<code>@args(注解类型列表)</code> • 例如：<code>@args(org.springframework.web.bind.annotation.RequestParam)</code></li>
<li><strong>bean(…)</strong> • 是 Spring AOP 特有的，用于匹配指定名称或符合名称模式的 Spring Bean。 • 基本格式为：<code>bean(beanName 或 beanNamePattern)</code> • 例如：<code>bean(*Service)</code> 表示匹配所有名称以 Service 结尾的 Bean 中的方法。</li>
<li><strong>逻辑运算符</strong> • 可以利用 <code>&amp;&amp;</code>、<code>||</code> 及<code>!</code>来组合和排除切入点表达式。 • 例如：<code>execution(* com.example..*(..)) &amp;&amp; @annotation(org.springframework.transaction.annotation.Transactional)</code> 表示匹配 com.example 包及子包下所有方法，并且该方法上必须有 @Transactional 注解。</li>
</ol>
<h3 id="Joinpoint-连接点"><a href="#Joinpoint-连接点" class="headerlink" title="Joinpoint 连接点"></a>Joinpoint 连接点</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.aop.aspect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Order(10000)</span> <span class="comment">//数字越小，优先级越高，数字越大，优先级越低; 数字越小，越先执行，就必须套到最外层</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//告诉Spring这个组件是个切面。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(int com.lfy.spring.aop.calculator.MathCalculator.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointCut</span><span class="params">()</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(&quot;pointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logStart</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        <span class="comment">//1、拿到方法全签名</span></span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//方法名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line">        <span class="comment">//目标方法传来的参数值</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】【&quot;</span>+name+<span class="string">&quot;】开始：参数列表：【&quot;</span>+ Arrays.toString(args) +<span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;pointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logEnd</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】【&quot;</span>+name+<span class="string">&quot;】后置...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(value = &quot;pointCut()&quot;,</span></span><br><span class="line"><span class="meta">                    returning = &quot;result&quot;)</span> <span class="comment">//returning=&quot;result&quot; 获取目标方法返回值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logReturn</span><span class="params">(JoinPoint joinPoint,Object result)</span>&#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】【&quot;</span>+name+<span class="string">&quot;】返回：值：&quot;</span>+result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(</span></span><br><span class="line"><span class="meta">            value = &quot;pointCut()&quot;,</span></span><br><span class="line"><span class="meta">            throwing = &quot;e&quot; //throwing=&quot;e&quot; 获取目标方法抛出的异常</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logException</span><span class="params">(JoinPoint joinPoint,Throwable e)</span>&#123;</span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> signature.getName();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;【切面 - 日志】【&quot;</span>+name+<span class="string">&quot;】异常：错误信息：【&quot;</span>+e.getMessage()+<span class="string">&quot;】&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pointcut-抽取切入点"><a href="#Pointcut-抽取切入点" class="headerlink" title="@Pointcut 抽取切入点"></a>@Pointcut 抽取切入点</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//告诉Spring这个组件是个切面。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(int com.lfy.spring.aop.calculator.MathCalculator.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointCut</span><span class="params">()</span>&#123;&#125;;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多切面执行顺序"><a href="#多切面执行顺序" class="headerlink" title="多切面执行顺序"></a>多切面执行顺序</h3><p>多切面同时切入同一个目标，则按照切面的优先级，优先级越高，越先执行，越是代理的最外层</p>
<blockquote>
<p>使用 @Order 注解指定顺序：</p>
<ul>
<li>数字越小，优先级越高，数字越大，优先级越低; 数字越小，越先执行，就必须套到最外层</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Order(10000)</span> <span class="comment">//数字越小，优先级越高，数字越大，优先级越低; 数字越小，越先执行，就必须套到最外层</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//告诉Spring这个组件是个切面。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Around-环绕通知"><a href="#Around-环绕通知" class="headerlink" title="@Around 环绕通知"></a>@Around 环绕通知</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AroundAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(int com.lfy.spring.aop.calculator.MathCalculator.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointCut</span><span class="params">()</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 环绕通知固定写法如下：</span></span><br><span class="line"><span class="comment">     * Object: 返回值</span></span><br><span class="line"><span class="comment">     * ProceedingJoinPoint: 可以继续推进的切点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;pointCut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">aroundAdvice</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        Object[] args = pjp.getArgs(); <span class="comment">// 获取目标方法的参数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 前置</span></span><br><span class="line">        System.out.println(<span class="string">&quot;环绕 - 前置通知：参数&quot;</span>+ Arrays.toString(args));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">proceed</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//接受传入参数的 proceed ，实现修改目标方法执行用的参数</span></span><br><span class="line">            proceed = pjp.proceed(args);<span class="comment">// 继续执行目标方法; 反射 method.invoke()</span></span><br><span class="line">            System.out.println(<span class="string">&quot;环绕 - 返回通知：返回值：&quot;</span>+proceed);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;环绕 - 异常通知：&quot;</span>+e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> e;  <span class="comment">//让别人继续感知</span></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;环绕 - 后置通知&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改返回值</span></span><br><span class="line">        <span class="keyword">return</span> proceed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AOP使用场景"><a href="#AOP使用场景" class="headerlink" title="AOP使用场景"></a>AOP使用场景</h3><ol>
<li><em><strong>日志记录【√】</strong></em><em>：在不修改业务代码的情况下，为方法调用添加日志记录功能。这有助于跟踪方法调用的时间、参数、返回值以及异常信息等。</em></li>
<li><em><strong>事务管理【√】</strong></em><em>：在服务层或数据访问层的方法上应用事务管理，确保数据的一致性和完整性。通过AOP，可以自动地为需要事务支持的方法添加事务开始、提交或回滚的逻辑。</em></li>
<li><em><strong>权限检查【√】</strong></em><em>：在用户访问某些资源或执行某些操作之前，进行权限检查。通过AOP，可以在不修改业务逻辑代码的情况下，为方法调用添加权限验证的逻辑。</em></li>
<li><em><strong>性能监控：</strong></em><em>专业框架；对方法的执行时间进行监控，以评估系统的性能瓶颈。AOP 可以帮助在不修改业务代码的情况下，为方法调用添加性能监控的逻辑。</em></li>
<li><em><strong>异常处理【√】：</strong></em> <em>集中处理业务逻辑中可能抛出的异常，并进行统一的日志记录或错误处理。通过AOP，可以为方法调用添加异常捕获和处理的逻辑。</em></li>
<li><em><strong>缓存管理【√】：</strong></em> <em>在方法调用前后添加缓存逻辑，以提高系统的响应速度和吞吐量。AOP 可以帮助实现缓存的自动加载、更新和失效等逻辑。</em></li>
<li><em><strong>安全审计：</strong></em><em>记录用户操作的历史记录，以便进行安全审计。通过AOP，可以在不修改业务逻辑代码的情况下，为方法调用添加安全审计的逻辑。</em></li>
<li><em><strong>自动化测试：</strong></em><em>在测试阶段，通过AOP为方法调用添加模拟（mock）或桩（stub）对象，以便进行单元测试或集成测试。</em></li>
</ol>
<h3 id="AOP重点小结"><a href="#AOP重点小结" class="headerlink" title="AOP重点小结"></a>AOP重点小结</h3><ol>
<li>熟悉 切面与通知方法的编写，理解如下通知；<ol>
<li>普通通知：前置、后置、返回、异常通知</li>
<li>环绕通知</li>
</ol>
</li>
<li>掌握两种常用 切入点表达式<ol>
<li>execution()</li>
<li>@annotation()</li>
</ol>
</li>
<li>理解 切面执行流程<ol>
<li><strong>单切面</strong>：<ol>
<li><strong>正常</strong>：前置 &#x3D;&#x3D;》目标 &#x3D;&#x3D;》返回 &#x3D;&#x3D;》后置</li>
<li><strong>异常</strong>：前置 &#x3D;&#x3D;》目标 &#x3D;&#x3D;》异常 &#x3D;&#x3D;》后置</li>
</ol>
</li>
<li><strong>多切面</strong>：按照切面优先级，@Order指定优先级，数字越小，优先级越高，越是代理最外层</li>
</ol>
</li>
</ol>
<h1 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h1><blockquote>
<p><strong>声明式事务</strong>：只需要告诉Spring框架，这个方法需要事务，框架会自动在运行方法时执行事务的流程控制逻辑。通过 Spring 的 @Transactional 注解，一键实现事务控制，不用编写任何代码</p>
</blockquote>
<p><em>【声明式】 vs 【编程式】</em></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>创建一个数据库 <code>spring_tx</code>，然后执行如下SQL</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for account</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `account`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `account`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">0</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">0</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  `balance` <span class="type">decimal</span>(<span class="number">10</span>, <span class="number">2</span>)  <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;余额&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">4</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of account</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `account` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;zhangsan&#x27;</span>, <span class="number">18</span>, <span class="number">10000.00</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `account` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;lisi&#x27;</span>, <span class="number">20</span>, <span class="number">10000.00</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `account` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;wangwu&#x27;</span>, <span class="number">16</span>, <span class="number">10000.00</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for book</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `book`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `book`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">0</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;图书id&#x27;</span>,</span><br><span class="line">  `bookName` <span class="type">varchar</span>(<span class="number">255</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;图书名&#x27;</span>,</span><br><span class="line">  `price` <span class="type">decimal</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;单价&#x27;</span>,</span><br><span class="line">  `stock` <span class="type">int</span>(<span class="number">0</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;库存量&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">4</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_0900_ai_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of book</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `book` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;剑指Java&#x27;</span>, <span class="number">100.00</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `book` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;剑指大数据&#x27;</span>, <span class="number">100.00</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `book` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;剑指Offer&#x27;</span>, <span class="number">100.00</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="JdbcTemplate（了解）"><a href="#JdbcTemplate（了解）" class="headerlink" title="JdbcTemplate（了解）"></a>JdbcTemplate（了解）</h2><blockquote>
<p>Spring 内置了操作数据库的组件 <code>JdbcTemplate</code>；通过如下实验。了解用法；</p>
</blockquote>
<h3 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h3><p>pom.xml 中导入数据库场景</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>annotationProcessor<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>application.properties 中配置数据源信息</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=<span class="string">spring-03-tx</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/spring_tx</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<h3 id="实验1：按照id查询图书"><a href="#实验1：按照id查询图书" class="headerlink" title="实验1：按照id查询图书"></a>实验1：按照id查询图书</h3><p>编写Book实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String bookName;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="keyword">private</span> Integer stock;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写 BookDao；</p>
<p><strong>核心方法:</strong></p>
<ul>
<li><code>jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper&lt;&gt;(Book.class), id);</code></li>
<li><code>BeanPropertyRowMapper</code>: 将JavaBean的属性名和数据库的字段名做一一映射</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照id查询图书</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">getBookById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、查询图书SQL</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from book where id  = ?&quot;</span>;</span><br><span class="line">        <span class="comment">//2、执行查询</span></span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> <span class="title class_">BeanPropertyRowMapper</span>&lt;&gt;(Book.class), id);</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单元测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.tx;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.spring.tx.bean.Book;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.spring.tx.dao.BookDao;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Spring03TxApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DataSource dataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testQuery</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">bookById</span> <span class="operator">=</span> bookDao.getBookById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;bookById = &quot;</span> + bookById);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// HikariDataSource；</span></span><br><span class="line">        <span class="comment">// DruidDataSource；</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> dataSource.getConnection();</span><br><span class="line">        System.out.println(connection);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验2：新增一个图书"><a href="#实验2：新增一个图书" class="headerlink" title="实验2：新增一个图书"></a>实验2：新增一个图书</h3><p>增删改方法都使用 <code> jdbcTemplate.update(sql,参数...);</code></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加图书</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">book</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addBook</span>(<span class="params"><span class="title class_">Book</span> book</span>)&#123;</span><br><span class="line">    <span class="title class_">String</span> sql = <span class="string">&quot;insert into book(bookName,price,stock) values (?,?,?)&quot;</span>;</span><br><span class="line">    jdbcTemplate.<span class="title function_">update</span>(sql,book.<span class="title function_">getBookName</span>(),book.<span class="title function_">getPrice</span>(),book.<span class="title function_">getStock</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验3：按照id修改图书库存"><a href="#实验3：按照id修改图书库存" class="headerlink" title="实验3：按照id修改图书库存"></a>实验3：按照id修改图书库存</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按照图书id修改图书库存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bookId 图书id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> num  要减几个</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateBookStock</span><span class="params">(Integer bookId,Integer num)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update book set stock=stock-? where id=?&quot;</span>;</span><br><span class="line">    jdbcTemplate.update(sql,num,bookId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验4：按照id删除图书"><a href="#实验4：按照id删除图书" class="headerlink" title="实验4：按照id删除图书"></a>实验4：按照id删除图书</h3><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 按照id删除图书</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">id</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">deleteBook</span>(<span class="params"><span class="title class_">Integer</span> id</span>)&#123;</span><br><span class="line">    <span class="title class_">String</span> sql = <span class="string">&quot;delete from book where id=?&quot;</span>;</span><br><span class="line">    jdbcTemplate.<span class="title function_">update</span>(sql,id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验5：按照username扣减账户余额"><a href="#实验5：按照username扣减账户余额" class="headerlink" title="实验5：按照username扣减账户余额"></a>实验5：按照username扣减账户余额</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.tx.dao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Propagation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照username扣减账户余额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 扣减的金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateBalanceByUsername</span><span class="params">(String username, BigDecimal delta)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update account set balance = balance - ? where username = ?&quot;</span>;</span><br><span class="line">        <span class="comment">// 执行SQL</span></span><br><span class="line">        jdbcTemplate.update(sql, delta, username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实验6：结账"><a href="#实验6：结账" class="headerlink" title="实验6：结账"></a>实验6：结账</h3><blockquote>
<p>定义 userService 接口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.tx.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户结账</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username  用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bookId    图书id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> buyNum    购买数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">checkout</span><span class="params">(String username, Integer bookId, Integer buyNum)</span> <span class="keyword">throws</span> InterruptedException, IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义 UserService 实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lfy.spring.tx.service.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.spring.tx.bean.Book;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.spring.tx.dao.AccountDao;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.spring.tx.dao.BookDao;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.spring.tx.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    BookDao bookDao;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param username  用户名</span></span><br><span class="line"><span class="comment">     * @param bookId    图书id</span></span><br><span class="line"><span class="comment">     * @param buyNum    购买数量</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkout</span><span class="params">(String username, Integer bookId, Integer buyNum)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        <span class="comment">//1、查询图书信息</span></span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> bookDao.getBookById(bookId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> book.getPrice();</span><br><span class="line">        <span class="comment">//2、计算扣减额度</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(buyNum).multiply(price);</span><br><span class="line">        <span class="comment">//3、扣减余额 </span></span><br><span class="line">        accountDao.updateBalanceByUsername(username,total);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、扣减库存 </span></span><br><span class="line">        bookDao.updateBookStock(bookId,buyNum);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Transactional：事务控制"><a href="#Transactional：事务控制" class="headerlink" title="@Transactional：事务控制"></a>@Transactional：事务控制</h2><h3 id="开启基于注解的声明式事务"><a href="#开启基于注解的声明式事务" class="headerlink" title="开启基于注解的声明式事务"></a>开启基于注解的声明式事务</h3><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">// 开启基于注解的自动化事务管理</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Spring03TxApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>) &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Spring03TxApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加事务注解：模拟正常提交与异常回滚"><a href="#添加事务注解：模拟正常提交与异常回滚" class="headerlink" title="添加事务注解：模拟正常提交与异常回滚"></a>添加事务注解：模拟正常提交与异常回滚</h3><ol>
<li>测试正常情况下数据提交</li>
<li>模拟出现异常后，事务自动回滚。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Transactional(timeout = 3)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkout</span><span class="params">(String username, Integer bookId, Integer buyNum)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        <span class="comment">//1、查询图书信息</span></span><br><span class="line">        <span class="type">Book</span> <span class="variable">book</span> <span class="operator">=</span> bookDao.getBookById(bookId);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">price</span> <span class="operator">=</span> book.getPrice();</span><br><span class="line">        <span class="comment">//2、计算扣减额度</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">total</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(buyNum).multiply(price);</span><br><span class="line">        <span class="comment">//3、扣减余额  //REQUIRED</span></span><br><span class="line">        accountDao.updateBalanceByUsername(username,total);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、扣减库存 //REQUIRES_NEW</span></span><br><span class="line">        bookDao.updateBookStock(bookId,buyNum);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5、抛出异常</span></span><br><span class="line"><span class="comment">//        int i = 10/0;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Transactional：事务属性"><a href="#Transactional：事务属性" class="headerlink" title="@Transactional：事务属性"></a>@Transactional：事务属性</h2><h3 id="transactionManager：事务管理器"><a href="#transactionManager：事务管理器" class="headerlink" title="transactionManager：事务管理器"></a>transactionManager：事务管理器</h3><p><em><strong>transactionManager</strong></em><em>：事务管理器; 控制事务的获取、提交、回滚。底层默认使用 JdbcTransactionManager；</em> <em>原理：</em></p>
<p><em><strong>事务管理器</strong></em><em>：</em><em><strong>TransactionManager</strong></em><em>； 控制提交和回滚</em></p>
<p><em><strong>事务拦截器</strong></em><em>：</em><em><strong>TransactionInterceptor</strong></em><em>： 控制何时提交和回滚</em></p>
<ol>
<li><em><code>completeTransactionAfterThrowing(txInfo, ex); </code></em> <em>在这个时候回滚</em></li>
<li><em><code>commitTransactionAfterReturning(txInfo); </code></em> <em>在这个时候提交</em></li>
<li>参考源码如下</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">PlatformTransactionManager</span> <span class="variable">ptm</span> <span class="operator">=</span> asPlatformTransactionManager(tm);</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">joinpointIdentification</span> <span class="operator">=</span> methodIdentification(method, targetClass, txAttr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (txAttr == <span class="literal">null</span> || !(ptm <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager cpptm)) &#123;</span><br><span class="line">    <span class="comment">// 获取事务信息</span></span><br><span class="line">    <span class="type">TransactionInfo</span> <span class="variable">txInfo</span> <span class="operator">=</span> createTransactionIfNecessary(ptm, txAttr, joinpointIdentification);</span><br><span class="line"></span><br><span class="line">    Object retVal;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">//执行目标方法</span></span><br><span class="line">       retVal = invocation.proceedWithInvocation();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">       <span class="comment">// 出异常，进行回滚</span></span><br><span class="line">       completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">       <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">       cleanupTransactionInfo(txInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (retVal != <span class="literal">null</span> &amp;&amp; txAttr != <span class="literal">null</span>) &#123;</span><br><span class="line">       <span class="type">TransactionStatus</span> <span class="variable">status</span> <span class="operator">=</span> txInfo.getTransactionStatus();</span><br><span class="line">       <span class="keyword">if</span> (status != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (retVal <span class="keyword">instanceof</span> Future&lt;?&gt; future &amp;&amp; future.isDone()) &#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                future.get();</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">catch</span> (ExecutionException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (txAttr.rollbackOn(ex.getCause())) &#123;</span><br><span class="line">                   status.setRollbackOnly();</span><br><span class="line">                &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">             &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123;</span><br><span class="line">             <span class="comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span></span><br><span class="line">             retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status);</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//一切正常进行提交</span></span><br><span class="line">    commitTransactionAfterReturning(txInfo);</span><br><span class="line">    <span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="timeout：超时控制"><a href="#timeout：超时控制" class="headerlink" title="timeout：超时控制"></a>timeout：超时控制</h3><p><em>timeout（同 timeoutString）：超时时间； 事务超时，秒为单位；</em></p>
<ul>
<li><em>一旦超过约定时间，事务就会回滚。</em></li>
<li><em>超时时间是指：从方法开始，到最后一次数据库操作结束的时间。</em></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照username扣减账户余额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 扣减的金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional(propagation = Propagation.REQUIRED,timeout = 5)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateBalanceByUsername</span><span class="params">(String username, BigDecimal delta)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;update account set balance = balance - ? where username = ?&quot;</span>;</span><br><span class="line">        <span class="comment">// 执行SQL</span></span><br><span class="line"><span class="comment">//        Thread.sleep(4000);</span></span><br><span class="line">        jdbcTemplate.update(sql, delta, username);</span><br><span class="line">        <span class="comment">//在这里睡多久都测试不出来超时</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="readOnly：只读优化"><a href="#readOnly：只读优化" class="headerlink" title="readOnly：只读优化"></a>readOnly：只读优化</h3><p>事务中仅有读操作，可以开启只读优化</p>
<h3 id="异常回滚机制：rollbackFor-与-noRollbackFor"><a href="#异常回滚机制：rollbackFor-与-noRollbackFor" class="headerlink" title="异常回滚机制：rollbackFor 与 noRollbackFor"></a>异常回滚机制：<code>rollbackFor </code>与 <code>noRollbackFor</code></h3><ul>
<li><em>rollbackFor（同rollbackForClassName）：指明哪些异常需要回滚。不是所有异常都一定引起事务回滚。</em>     <em>异常：</em>          <em>运行时异常（unchecked exception【非受检异常】）</em>          <em>编译时异常（checked exception【受检异常】）</em>     <em>【回滚的默认机制】</em>          <em>运行时异常：回滚</em>          <em>编译时异常：不回滚</em>     <em>【可以指定哪些异常需要回滚】；</em>    <em>【回滚 &#x3D; 运行时异常 + 指定回滚异常】</em></li>
<li><em>noRollbackFor（同 noRollbackForClassName）：指明哪些异常不需要回滚。</em>    <em>【不回滚 &#x3D; 编译时异常 + 指定不回滚异常】</em></li>
</ul>
<h3 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h3><p><strong>读未提交（Read Uncommitted）：</strong></p>
<ul>
<li>事务可以读取未被提交的数据，易产生脏读、不可重复读和幻读等问题</li>
</ul>
<p><strong>读已提交（Read Committed）</strong></p>
<ul>
<li>事务只能读取已经提交的数据，可避免脏读，但可能引发不可重复读和幻读。</li>
</ul>
<p><strong>可重复读（Repeatable Read）</strong></p>
<ul>
<li>同一事务期间多次重复读取的数据相同。避免脏读和不可重复读，但仍有幻读的问题</li>
</ul>
<p><strong>串行化（Serializable）</strong></p>
<p>最高隔离级别，完全禁止了并发，只允许一个事务执行完毕之后才能执行另一个事务</p>
<p>BookDao中添加如下代码，修改隔离级别，尝试读取数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(<span class="params">isolation = Isolation.REPEATABLE_READ</span>)</span></span><br><span class="line">public BigDecimal getBookPrice(Integer <span class="built_in">id</span>)&#123;</span><br><span class="line">    String sql = <span class="string">&quot;select price from book where id=?&quot;</span>;</span><br><span class="line">    BigDecimal decimal1 = jdbcTemplate.queryForObject(sql, BigDecimal.<span class="keyword">class</span>, <span class="built_in">id</span>);</span><br><span class="line"></span><br><span class="line">    BigDecimal decimal2 = jdbcTemplate.queryForObject(sql, BigDecimal.<span class="keyword">class</span>, <span class="built_in">id</span>);</span><br><span class="line"></span><br><span class="line">    BigDecimal decimal3 = jdbcTemplate.queryForObject(sql, BigDecimal.<span class="keyword">class</span>, <span class="built_in">id</span>);</span><br><span class="line"></span><br><span class="line">    BigDecimal decimal4 = jdbcTemplate.queryForObject(sql, BigDecimal.<span class="keyword">class</span>, <span class="built_in">id</span>);</span><br><span class="line"></span><br><span class="line">    BigDecimal decimal5 = jdbcTemplate.queryForObject(sql, BigDecimal.<span class="keyword">class</span>, <span class="built_in">id</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.queryForObject(sql,BigDecimal.<span class="keyword">class</span>,<span class="built_in">id</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="传播行为"><a href="#传播行为" class="headerlink" title="传播行为"></a>传播行为</h3><p>定义：当事务产生嵌套，大事务中包含很多小事务的时候，小事务要不要和大事务共用一个事务设置；</p>
<p>也就是事务如何传播下去</p>
<p> <em><strong>场景：用户结账，炸了以后，金额扣减回滚，库存不回滚。</strong></em> <em><strong>注意：【一定关注异常的传播链】</strong></em> <em>实现：</em>    <em>checkout(){</em>        <em>&#x2F;&#x2F;自己的操作；</em>        <em>扣减金额： &#x2F;&#x2F;REQUIRED</em>        <em>扣减库存： &#x2F;&#x2F;REQUIRES_NEW</em>    <em>}</em></p>
<p><strong>&#x2F;&#x2F;思考如下情况：哪些事务会回滚，哪些不会回滚</strong>  <em>A {</em>      <em>B(){  &#x2F;&#x2F;REQUIRED</em>          <em>F();&#x2F;&#x2F;REQUIRES_NEW</em>          <em>G();&#x2F;&#x2F;REQUIRED</em>          <em>H();&#x2F;&#x2F;REQUIRES_NEW</em>      <em>}</em>      <em>C(){  &#x2F;&#x2F;REQUIRES_NEW</em>         <em>I();&#x2F;&#x2F;REQUIRES_NEW</em>         <em>J();&#x2F;&#x2F;REQUIRED</em>      <em>}</em>      <em>D(){   &#x2F;&#x2F;REQUIRES_NEW</em>          <em>K();&#x2F;&#x2F;REQUIRES_NEW</em>          <em>L();&#x2F;&#x2F;REQUIRES_NEW &#x2F;&#x2F;点位2： 10&#x2F;0； K,F,H,C(i,j) &#x3D; ok, E整个代码走不到，剩下炸</em>      <em>}</em>      <em>E(){   &#x2F;&#x2F;REQUIRED</em>          <em>M();&#x2F;&#x2F;REQUIRED</em>          <em>&#x2F;&#x2F;点位3：10&#x2F;0；  F,H,C(i,j),D(K,L)&#x3D; ok</em>          <em>N();&#x2F;&#x2F;REQUIRES_NEW</em>      <em>}</em>       <em>int i &#x3D; 10&#x2F;0;  &#x2F;&#x2F;点位1：C（I，J）,D(K，L) ，F，H,N&#x3D; ok</em>  <em>}</em></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">lele</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/09/21/spring/">http://example.com/2025/09/21/spring/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/30/springmvc/" title="springmvc"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">springmvc</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/20/maven/" title="maven"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">maven</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring"><span class="toc-text">Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%A1%86%E6%9E%B6"><span class="toc-text">什么是框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Framework"><span class="toc-text">Spring Framework</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-%E6%A8%A1%E5%9D%97%E5%88%92%E5%88%86"><span class="toc-text">Spring 模块划分</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8"><span class="toc-text">容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E5%92%8C%E5%AE%B9%E5%99%A8"><span class="toc-text">组件和容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AE%B9%E5%99%A8%E5%92%8C%E7%BB%84%E4%BB%B6%E6%A1%88%E4%BE%8B"><span class="toc-text">常见的容器和组件案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IOC%E5%92%8CDI"><span class="toc-text">IOC和DI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%B3%A8%E5%86%8C"><span class="toc-text">组件注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C1%EF%BC%9A-Bean"><span class="toc-text">实验1：@Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E4%B8%80%E4%B8%AAJavaBean"><span class="toc-text">准备一个JavaBean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%AE%B9%E5%99%A8%E4%B8%AD"><span class="toc-text">注册容器中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E5%AE%B9%E5%99%A8%E4%B8%AD%E8%8E%B7%E5%8F%96"><span class="toc-text">从容器中获取</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C2%EF%BC%9A-%E8%8E%B7%E5%8F%96Bean"><span class="toc-text">实验2： 获取Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C3%EF%BC%9A-Configuration"><span class="toc-text">实验3：@Configuration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C4-7%EF%BC%9Amvc%E5%88%86%E5%B1%82%E6%B3%A8%E8%A7%A3"><span class="toc-text">实验4-7：mvc分层注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C8%EF%BC%9A-ComponentScan"><span class="toc-text">实验8：@ComponentScan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C9%EF%BC%9A-Import"><span class="toc-text">实验9：@Import</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C10%EF%BC%9A-Scope"><span class="toc-text">实验10：@Scope</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C11%EF%BC%9A-Lazy"><span class="toc-text">实验11：@Lazy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C12%EF%BC%9AFactoryBean"><span class="toc-text">实验12：FactoryBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C13%EF%BC%9A-Conditional%E3%80%90%E9%9A%BE%E7%82%B9%E3%80%91"><span class="toc-text">实验13：@Conditional【难点】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9Fconditional"><span class="toc-text">原生conditional</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">条件接口实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%A0%87%E6%B3%A8%E5%9C%A8%E7%BB%84%E4%BB%B6%E4%B8%8A"><span class="toc-text">条件标注在组件上</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%9D%A1%E4%BB%B6%E6%98%AF%E5%90%A6%E7%94%9F%E6%95%88"><span class="toc-text">测试条件是否生效</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Conditional-%E6%B4%BE%E7%94%9F%E6%B3%A8%E8%A7%A3"><span class="toc-text">@Conditional 派生注解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%B3%A8%E5%85%A5"><span class="toc-text">组件注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C1%EF%BC%9A-Autowired"><span class="toc-text">实验1：@Autowired</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C2%EF%BC%9A-Qualifier"><span class="toc-text">实验2：@Qualifier</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C3%EF%BC%9A-Primary"><span class="toc-text">实验3：@Primary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C4%EF%BC%9A-Resource"><span class="toc-text">实验4：@Resource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C5%EF%BC%9Asetter%E6%96%B9%E6%B3%95%E6%B3%A8%E5%85%A5"><span class="toc-text">实验5：setter方法注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C6%EF%BC%9A%E6%9E%84%E9%80%A0%E5%99%A8%E6%B3%A8%E5%85%A5"><span class="toc-text">实验6：构造器注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C7%EF%BC%9AxxxAware"><span class="toc-text">实验7：xxxAware</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C8%EF%BC%9A-Value"><span class="toc-text">实验8：@Value</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C9%EF%BC%9ASpEL"><span class="toc-text">实验9：SpEL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C10%EF%BC%9A-PropertySource"><span class="toc-text">实验10：@PropertySource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C11%EF%BC%9A-Profile"><span class="toc-text">实验11：@Profile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-text">组件生命周期（了解）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C1%EF%BC%9A-Bean-1"><span class="toc-text">实验1：@Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C2-3%EF%BC%9AInitializingBean%E3%80%81DisposableBean"><span class="toc-text">实验2-3：InitializingBean、DisposableBean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C4-5%EF%BC%9A-PostConstruct%E3%80%81-PreDestroy"><span class="toc-text">实验4-5：@PostConstruct、@PreDestroy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C6%EF%BC%9ABeanPostProcessor"><span class="toc-text">实验6：BeanPostProcessor</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AOP"><span class="toc-text">AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E6%90%AD%E5%BB%BA"><span class="toc-text">场景搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MathCalculator-%E6%8E%A5%E5%8F%A3"><span class="toc-text">MathCalculator 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MathCalculatorImpl-%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="toc-text">MathCalculatorImpl 实现类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%E5%8A%A0%E6%97%A5%E5%BF%97"><span class="toc-text">给计算方法加日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-text">添加日志业务实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97"><span class="toc-text">静态代理实现添加日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97"><span class="toc-text">动态代理实现添加日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOP-%E5%AE%9E%E7%8E%B0"><span class="toc-text">AOP 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">核心概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-text">实现步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5aop%E4%BE%9D%E8%B5%96"><span class="toc-text">导入aop依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%88%87%E9%9D%A2"><span class="toc-text">编写切面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%80%9A%E7%9F%A5%E6%96%B9%E6%B3%95"><span class="toc-text">编写通知方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%87%E5%85%A5%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">切入点表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOP%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-text">AOP功能测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOP%E5%8E%9F%E7%90%86"><span class="toc-text">AOP原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOP-%E7%BB%86%E8%8A%82"><span class="toc-text">AOP 细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%9F%A5%E6%96%B9%E6%B3%95%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">通知方法执行顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E5%85%A5%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F-1"><span class="toc-text">切入点表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Joinpoint-%E8%BF%9E%E6%8E%A5%E7%82%B9"><span class="toc-text">Joinpoint 连接点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pointcut-%E6%8A%BD%E5%8F%96%E5%88%87%E5%85%A5%E7%82%B9"><span class="toc-text">@Pointcut 抽取切入点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%88%87%E9%9D%A2%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-text">多切面执行顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Around-%E7%8E%AF%E7%BB%95%E9%80%9A%E7%9F%A5"><span class="toc-text">@Around 环绕通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOP%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">AOP使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOP%E9%87%8D%E7%82%B9%E5%B0%8F%E7%BB%93"><span class="toc-text">AOP重点小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">声明式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JdbcTemplate%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-text">JdbcTemplate（了解）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-text">配置数据源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C1%EF%BC%9A%E6%8C%89%E7%85%A7id%E6%9F%A5%E8%AF%A2%E5%9B%BE%E4%B9%A6"><span class="toc-text">实验1：按照id查询图书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C2%EF%BC%9A%E6%96%B0%E5%A2%9E%E4%B8%80%E4%B8%AA%E5%9B%BE%E4%B9%A6"><span class="toc-text">实验2：新增一个图书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C3%EF%BC%9A%E6%8C%89%E7%85%A7id%E4%BF%AE%E6%94%B9%E5%9B%BE%E4%B9%A6%E5%BA%93%E5%AD%98"><span class="toc-text">实验3：按照id修改图书库存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C4%EF%BC%9A%E6%8C%89%E7%85%A7id%E5%88%A0%E9%99%A4%E5%9B%BE%E4%B9%A6"><span class="toc-text">实验4：按照id删除图书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C5%EF%BC%9A%E6%8C%89%E7%85%A7username%E6%89%A3%E5%87%8F%E8%B4%A6%E6%88%B7%E4%BD%99%E9%A2%9D"><span class="toc-text">实验5：按照username扣减账户余额</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C6%EF%BC%9A%E7%BB%93%E8%B4%A6"><span class="toc-text">实验6：结账</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transactional%EF%BC%9A%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6"><span class="toc-text">@Transactional：事务控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">开启基于注解的声明式事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BA%8B%E5%8A%A1%E6%B3%A8%E8%A7%A3%EF%BC%9A%E6%A8%A1%E6%8B%9F%E6%AD%A3%E5%B8%B8%E6%8F%90%E4%BA%A4%E4%B8%8E%E5%BC%82%E5%B8%B8%E5%9B%9E%E6%BB%9A"><span class="toc-text">添加事务注解：模拟正常提交与异常回滚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Transactional%EF%BC%9A%E4%BA%8B%E5%8A%A1%E5%B1%9E%E6%80%A7"><span class="toc-text">@Transactional：事务属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#transactionManager%EF%BC%9A%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-text">transactionManager：事务管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#timeout%EF%BC%9A%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-text">timeout：超时控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readOnly%EF%BC%9A%E5%8F%AA%E8%AF%BB%E4%BC%98%E5%8C%96"><span class="toc-text">readOnly：只读优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%9B%9E%E6%BB%9A%E6%9C%BA%E5%88%B6%EF%BC%9ArollbackFor-%E4%B8%8E-noRollbackFor"><span class="toc-text">异常回滚机制：rollbackFor 与 noRollbackFor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-text">隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-text">传播行为</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By lele</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>